<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>

  <title>Sản phẩm | MXD</title>
  <meta id="desc" name="description" content="Trang sản phẩm MXD. Vui lòng bật JavaScript."/>
  <link id="canonical" rel="canonical" href="https://tuyetlethi83a.github.io/g.html"/>
  <meta id="robots" name="robots" content="index,follow"/>

  <meta property="og:title" content="Sản phẩm | MXD"/>
  <meta id="ogdesc" property="og:description" content="Trang sản phẩm theo SKU từ affiliates.json"/>
  <meta id="ogurl" property="og:url" content="https://tuyetlethi83a.github.io/g.html"/>
  <meta id="ogimg" property="og:image" content="https://tuyetlethi83a.github.io/assets/og/default-og.webp"/>

  <link rel="stylesheet" href="/assets/site.css"/>
  <script defer src="/assets/analytics.js"></script>
  <script defer src="/assets/mxd-affiliate.js"></script>
</head>
<body>
<header><h1 id="title">Sản phẩm</h1></header>

<div class="container" id="content"><p>Đang tải…</p></div>

<footer><div class="container"><small class="muted">Lấy dữ liệu từ affiliates.json qua ?sku=</small></div></footer>

<script>
  function setMeta(p){
    var absImg = new URL(p.image, location.origin).href;
    var u = location.origin + '/g.html?sku=' + encodeURIComponent(p.sku);
    document.getElementById('canonical').href = u;
    document.getElementById('ogurl').setAttribute('content', u);
    document.getElementById('ogimg').setAttribute('content', absImg);
    document.getElementById('desc').setAttribute('content', p.name);
    document.getElementById('ogdesc').setAttribute('content', p.name);
    document.title = p.name + ' | MXD';
  }

  function fmtPrice(v){
    var n = Number(v);
    if (!Number.isFinite(n)) return '';
    return n.toLocaleString('vi-VN') + ' ₫';
  }

  function getParam(name){ return new URL(location.href).searchParams.get(name); }

  document.addEventListener('DOMContentLoaded', async function(){
    var sku = getParam('sku');
    var wrap = document.getElementById('content');
    var h1 = document.getElementById('title');

    if(!sku){ wrap.innerHTML = '<p>Thiếu ?sku=</p>'; return; }

    let resp;
    try {
      resp = await fetch('/affiliates.json', {cache:'no-store'});
    } catch(e) {
      wrap.innerHTML = '<p>Lỗi tải dữ liệu.</p>'; return;
    }
    if(!resp.ok){ wrap.innerHTML = '<p>Lỗi tải dữ liệu.</p>'; return; }

    var data = await resp.json();
    var p = Array.isArray(data) ? data.find(function(x){ return x.sku === sku; }) : null;

    if(!p){
      document.getElementById('robots').setAttribute('content','noindex,follow');
      wrap.innerHTML = '<p>Không tìm thấy SKU.</p>'; return;
    }

    // Fallback các khóa theo chuẩn MXD
    var priceRaw = (p.price_vnd ?? p.price);
    var originHref = (p.origin_url ?? p.origin ?? '#');
    var priceText = fmtPrice(priceRaw);

    setMeta(p);
    h1.textContent = p.name;

    // JSON-LD (chỉ thêm offers khi có giá hợp lệ)
    var ld = {
      "@context":"https://schema.org",
      "@type":"Product",
      "name": p.name,
      "sku": p.sku,
      "image": [ new URL(p.image, location.origin).href ],
      "description": p.name
    };
    var priceNum = Number(priceRaw);
    if (Number.isFinite(priceNum)) {
      ld.offers = {
        "@type":"Offer",
        "priceCurrency":"VND",
        "price": String(priceNum),
        "availability":"https://schema.org/InStock",
        "url": new URL('/g.html?sku='+encodeURIComponent(p.sku), location.origin).href
      };
    }
    var s = document.createElement('script');
    s.type = 'application/ld+json';
    s.textContent = JSON.stringify(ld);
    document.head.appendChild(s);

    // Render
    var priceBlock = priceText ? ('<p><strong>'+ priceText +'</strong></p>') : '';
    wrap.innerHTML = ''
      + '<div class="card product-card">'
      +   '<a class="product-meta"'
      +     ' href="' + originHref + '"'
      +     ' data-merchant="' + (p.merchant||'') + '"'
      +     ' data-sku="' + p.sku + '"'
      +     ' data-img="' + (p.image||'') + '"'
      +     (Number.isFinite(priceNum) ? (' data-price="'+ priceNum +'"') : '')
      +   '>' + p.name + '</a>'
      +   '<img src="' + p.image + '" alt="' + p.name + '"/>'
      +     priceBlock
      +   '<p><span class="badge">' + (p.merchant||'') + '</span></p>'
      +   '<p><a class="btn buy" href="#">Mua tại nơi gốc</a></p>'
      + '</div>';
  });
</script>
</body>
</html>
