<!-- REPLACE WHOLE FILE: /tools/tuyetlethi-importer.html -->
<!-- FIND: TUYETLETHI-TOOL v4.3.9-lite -->
<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Tuyetlethi Importer v4.3.9 LITE — Light, Gọn, Có X‑Key</title>
  <meta name="robots" content="noindex,follow"/>
  <style>
    :root{
      --bg:#f7fafc; --fg:#0b1320; --muted:#5b6b7c; --b:#ffffff; --line:#dbe2ea; --accent:#2563eb;
      --ok:#16a34a; --warn:#f59e0b; --err:#dc2626; --chip:#f1f5f9;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; background:var(--bg); color:var(--fg); font:14px/1.45 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial}
    h1{font-size:20px; margin:16px 0 8px}
    h2{font-size:16px; margin:14px 0 8px}
    a{color:var(--accent)}
    .wrap{max-width:920px; margin:0 auto; padding:14px}
    .card{background:var(--b); border:1px solid var(--line); border-radius:12px; padding:12px; margin-bottom:12px}
    label{display:block; font-weight:600; margin:6px 0}
    input,select,textarea,button{width:100%; padding:10px; border-radius:10px; border:1px solid var(--line); background:#fff; color:var(--fg)}
    textarea{min-height:68px; resize:vertical}
    .row{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
    .row>*{flex:1}
    .btn{cursor:pointer; background:#eef2ff; border:1px solid #c7d2fe}
    .btn.primary{background:var(--accent); color:#fff; border-color:var(--accent)}
    .btn.ok{background:#eaf7ef; border-color:#c9edd6}
    .btn.warn{background:#fff7e6; border-color:#ffe0a6}
    .btn.err{background:#fee2e2; border-color:#fecaca}
    .pill{display:inline-block; background:var(--chip); border:1px solid var(--line); border-radius:999px; padding:2px 8px; font-size:12px; margin-left:6px}
    .drop{border:2px dashed #cbd5e1; border-radius:12px; padding:14px; text-align:center; background:#fff}
    .drop.dragover{border-color:var(--accent); background:#eef2ff}
    .preview{display:flex; gap:10px; align-items:center}
    .preview img{width:96px; height:96px; object-fit:cover; border-radius:10px; border:1px solid var(--line)}
    .muted{color:var(--muted)}
    .toast{position:fixed; right:12px; top:12px; display:none; max-width:520px; background:#111827; color:#f9fafb; border:1px solid #1f2937; border-radius:12px; padding:10px 12px; box-shadow:0 10px 30px #0005; z-index:9999}
    .toast.show{display:block}
    .status.ok{color:var(--ok)} .status.warn{color:var(--warn)} .status.err{color:var(--err)}
    .dock{position:fixed; right:12px; bottom:12px; width:360px; max-height:200px; background:#fff; border:1px solid var(--line); border-radius:10px; overflow:auto; padding:8px; font:12px/1.35 ui-monospace,Consolas,Menlo}
    .dock h3{margin:0 0 6px; font:600 12px/1.2 ui-sans-serif}
    .nowrap{white-space:nowrap}
  </style>
</head>
<body>
<div class="wrap">
  <h1>Tuyetlethi Importer v4.3.9 LITE <span class="pill">Light theme</span> <span class="pill">Gọn</span> <span class="pill">X‑Key</span></h1>

  <div class="card">
    <h2>1) Cài đặt</h2>
    <div class="row">
      <div>
        <label>Worker Base URL</label>
        <input id="workerUrl" placeholder="https://tuyetlethi83a.mxd6686.workers.dev"/>
      </div>
      <div>
        <label>X‑Key (header bảo vệ Worker)</label>
        <input id="xKey" placeholder="ví dụ: tuyet-2025-super"/>
      </div>
    </div>
    <div class="row">
      <button class="btn" id="save">💾 Lưu</button>
      <button class="btn" id="load">↻ Tải</button>
      <button class="btn" id="clear">🗑 Xóa</button>
      <button class="btn" id="chkHealth">Kiểm tra Worker</button>
      <button class="btn" id="chkKey">Kiểm tra X‑Key</button>
      <button class="btn" id="testPing">Test upload 1×1</button>
      <span id="stat" class="muted"></span>
    </div>
  </div>

  <div class="card">
    <h2>2) Ảnh đơn lẻ</h2>
    <div class="row">
      <div style="flex:1">
        <label>SKU (nếu trống sẽ lấy theo tên file)</label>
        <input id="sku" placeholder="ao-thun-nu-co-tron"/>
      </div>
      <div style="flex:1">
        <label>Thư mục ảnh</label>
        <select id="folder">
          <option value="/assets/img/products/">/assets/img/products/</option>
          <option value="/assets/img/categories/">/assets/img/categories/</option>
          <option value="/assets/img/og/">/assets/img/og/</option>
        </select>
      </div>
      <div style="flex:1">
        <label>Định dạng</label>
        <select id="fmt"><option value="webp">webp</option><option value="png">png</option></select>
      </div>
    </div>
    <div id="drop" class="drop">Kéo ảnh vào đây hoặc bấm chọn…</div>
    <input type="file" id="file" accept="image/*" style="display:none"/>
    <div id="pv" class="preview" style="display:none; margin-top:10px">
      <img id="thumb" alt="preview"/>
      <div class="muted">
        <div><b>Tên xuất:</b> <span id="outName" class="nowrap">–</span></div>
        <div><b>Kích thước:</b> <span id="outInfo">–</span></div>
      </div>
    </div>
    <div class="row" style="margin-top:8px">
      <button class="btn" id="pick">Chọn ảnh</button>
      <button class="btn" id="saveLocal">Tải (.webp)</button>
      <button class="btn primary" id="upload">Upload lên repo</button>
      <span class="muted">Tên ảnh sẽ là <code id="pathText">/assets/img/products/sku.webp</code></span>
    </div>
  </div>

  <div class="card">
    <h2>3) Publish (tùy chọn, gọn)</h2>
    <div class="row">
      <div><label>Tên</label><input id="name" placeholder="Ví dụ: Áo thun…"/></div>
      <div><label>Giá (VND)</label><input id="price" type="number" placeholder="399000"/></div>
    </div>
    <div class="row">
      <div><label>Origin</label><input id="origin" placeholder="https://shopee.vn/…"/></div>
      <div>
        <label>Merchant</label>
        <select id="merchant"><option value="shopee">shopee</option><option value="lazada">lazada</option></select>
      </div>
    </div>
    <div class="row">
      <div><label>Ảnh (đường dẫn)</label><input id="image" placeholder="/assets/img/products/sku.webp"/></div>
      <div><label>Danh mục</label><input id="category" placeholder="thoi-trang / my-pham / me-va-be / trang-suc"/></div>
    </div>
    <div class="row" style="margin-top:8px">
      <button class="btn primary" id="publish">Publish → Store</button>
      <span id="pubStat" class="muted"></span>
    </div>
  </div>
</div>

<div id="toast" class="toast" role="status" aria-live="polite">–</div>
<div class="dock" id="dock"><h3>Log</h3><div id="log">–</div></div>

<script>
// ===== v4.3.9‑lite (TUYETLETHI-TOOL) =====
const $ = s => document.querySelector(s);
const LS_KEY = 'TUYETLETHI_IMPORTER_SETTINGS_V439_LITE';
const slug = s => (s||'').toString().normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/đ/g,'d').replace(/Đ/g,'D').toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/^-+|-+$/g,'');
const toast = (m)=>{ const t=$('#toast'); t.textContent=m; t.classList.add('show'); clearTimeout(toast.t); toast.t=setTimeout(()=>t.classList.remove('show'),4200); };
const log = (m)=>{ const d=$('#log'); d.textContent = (d.textContent && d.textContent!=='–'? d.textContent+'\n':'') + m; const box=$('#dock'); box.scrollTop=box.scrollHeight; };

// Settings
function readS(){ try{return JSON.parse(localStorage.getItem(LS_KEY)||'{}')}catch(_){return{}} }
function writeS(v){ localStorage.setItem(LS_KEY, JSON.stringify(v)); }
function uiToS(){ return { workerUrl:$('#workerUrl').value.trim(), xKey:$('#xKey').value.trim() } }
function sToUi(s){ $('#workerUrl').value=s.workerUrl||''; $('#xKey').value=s.xKey||''; updatePathHint(); }
function save(){ writeS(uiToS()); toast('Đã lưu cài đặt'); }
function load(){ sToUi(readS()); toast('Đã tải cài đặt'); }
function clearAll(){ localStorage.removeItem(LS_KEY); sToUi({}); toast('Đã xóa cài đặt'); }
$('#save').onclick=save; $('#load').onclick=load; $('#clear').onclick=clearAll; load();

function hdr(json=true){ const s=readS(); const h={}; if(json) h['content-type']='application/json'; if(s.xKey) h['x-key']=s.xKey; return h; }
function base(){ const s=readS(); return (s.workerUrl||'').replace(/\/$/,''); }

// Health / Key
$('#chkHealth').onclick=async()=>{ if(!base()) return toast('Chưa cấu hình Worker'); try{ const r=await fetch(base()+'/health',{mode:'cors'}); $('#stat').textContent = r.ok? 'Worker OK ('+r.status+')' : 'Worker lỗi '+r.status; log('[health] '+r.status); toast(r.ok?'Worker OK':'Worker lỗi '+r.status); }catch(e){ toast('Health lỗi: '+e.message); log('health EXC '+e.message); } };
$('#chkKey').onclick=async()=>{ if(!base()) return toast('Chưa cấu hình Worker'); try{ const r=await fetch(base()+'/whoami',{mode:'cors', headers: hdr(false)}); const txt=await r.text().catch(()=>'' ); $('#stat').textContent = r.ok? 'X‑Key hợp lệ' : ('X‑Key sai '+r.status); log('[whoami] '+r.status+' '+txt.slice(0,100)); toast(r.ok?'X‑Key OK':'X‑Key sai'); }catch(e){ toast('Whoami lỗi: '+e.message); log('whoami EXC '+e.message); } };

// Image flow (single)
const drop=$('#drop'), file=$('#file'), thumb=$('#thumb');
const state={blob:null,w:0,h:0,name:''};
function updatePathHint(){ const sku=($('#sku').value||'tt').trim(); const folder=$('#folder').value; const ext=$('#fmt').value==='png'?'.png':'.webp'; $('#pathText').textContent=folder+slug(sku||'tt')+ext; }
['sku','folder','fmt'].forEach(id=>{ const el=$('#'+id); el&&el.addEventListener('input',updatePathHint); });

drop.addEventListener('click', ()=> file.click());
drop.addEventListener('dragover', e=>{ e.preventDefault(); drop.classList.add('dragover'); });
drop.addEventListener('dragleave', ()=> drop.classList.remove('dragover'));
drop.addEventListener('drop', e=>{ e.preventDefault(); drop.classList.remove('dragover'); if(e.dataTransfer.files?.length) handle(e.dataTransfer.files[0]); });
$('#pick').onclick=()=> file.click();
file.onchange=e=>{ if(e.target.files?.length) handle(e.target.files[0]); };

function baseName(f){ const n=(f.name||'').split('/').pop(); const i=n.lastIndexOf('.'); return (i>0?n.slice(0,i):n); }
function handle(f){ const sku=$('#sku').value.trim(); const out=slug(sku||baseName(f)||'tt'); const fmt=$('#fmt').value; const reader=new FileReader(); reader.onload=ev=>{ const img=new Image(); img.onload=()=>{ const max=1200, scale=Math.min(1, max/Math.max(img.width,img.height)); const w=Math.round(img.width*scale), h=Math.round(img.height*scale); const c=document.createElement('canvas'); c.width=w; c.height=h; c.getContext('2d').drawImage(img,0,0,w,h); const mime = fmt==='png'? 'image/png':'image/webp'; const q = fmt==='png'?1.0:0.82; c.toBlob(b=>{ state.blob=b; state.w=w; state.h=h; state.name=out+(fmt==='png'?'.png':'.webp'); $('#pv').style.display='flex'; thumb.src=URL.createObjectURL(b); $('#outName').textContent=state.name; $('#outInfo').textContent=w+'×'+h+', '+(b.size/1024|0)+' KB'; updatePathHint(); }, mime, q); }; img.src=ev.target.result; }; reader.readAsDataURL(f); }

$('#saveLocal').onclick=()=>{ if(!state.blob) return toast('Chưa có ảnh'); const a=document.createElement('a'); a.href=URL.createObjectURL(state.blob); a.download=state.name||'product.webp'; a.click(); };

function blobToDataURL(b){ return new Promise(res=>{ const fr=new FileReader(); fr.onload=()=>res(fr.result); fr.readAsDataURL(b); }); }
function splitData(d){ const m=String(d||'').match(/^data:([^;]+);base64,(.+)$/); return m?{mime:m[1],base64:m[2]}:{mime:'',base64:d||''}; }

async function uploadJSON(path, dataUrl){ return fetch(base()+'/upload-image',{method:'POST',mode:'cors',headers:hdr(true),body:JSON.stringify({sku:slug($('#sku').value||'tt'), path, file:dataUrl})}); }
async function uploadForm(path, blob){ const fd=new FormData(); fd.append('file', blob, state.name||'img.webp'); fd.append('path', path); fd.append('commit','feat(images): upload via importer-lite'); const h=hdr(false); return fetch(base()+'/ops/upload',{method:'POST',mode:'cors',headers:h,body:fd}); }

$('#upload').onclick=async()=>{
  if(!base()) return toast('Chưa cấu hình Worker');
  if(!state.blob) return toast('Chưa có ảnh');
  const folder=$('#folder').value, ext=$('#fmt').value==='png'?'.png':'.webp'; const sku=slug($('#sku').value||state.name||'tt'); const path=folder+sku+ext;
  try{
    const dataUrl=await blobToDataURL(state.blob);
    let r=await uploadJSON(path, dataUrl); let text=await r.text().catch(()=>'' ); log(`[upload-json ${path}] ${r.status} ${r.ok?'OK':'FAIL'}`);
    if(!r.ok){ const {mime,base64}=splitData(dataUrl); r=await fetch(base()+'/upload-image',{method:'POST',mode:'cors',headers:hdr(true),body:JSON.stringify({sku:sku, path, file:base64, mime})}); text=await r.text().catch(()=>'' ); log(`[upload-json(base64) ${path}] ${r.status} ${r.ok?'OK':'FAIL'}`); }
    if(!r.ok){ r=await uploadForm(path, state.blob); text=await r.text().catch(()=>'' ); log(`[upload-form ${path}] ${r.status} ${r.ok?'OK':'FAIL'}`); }
    if(!r.ok){ toast('Upload lỗi '+r.status); log(text.slice(0,180)); return; }
    toast('Đã upload: '+path); $('#image').value=path;
  }catch(e){ toast('Lỗi: '+e.message); log('upload EXC '+e.message); }
};

// Test upload 1×1 (webp)
$('#testPing').onclick=async()=>{
  if(!base()) return toast('Chưa cấu hình Worker');
  const c=document.createElement('canvas'); c.width=1; c.height=1; const b=await new Promise(res=>c.toBlob(res,'image/webp',0.5));
  const dataUrl=await blobToDataURL(b); const path='/assets/img/test/ping.webp';
  try{
    let r=await uploadJSON(path,dataUrl); if(!r.ok) r=await uploadForm(path,b); log(`[ping] ${r.status}`); toast(r.ok?'Ping OK':'Ping FAIL '+r.status);
  }catch(e){ toast('Ping lỗi: '+e.message); }
};

// Publish minimal
$('#publish').onclick=async()=>{
  if(!base()) return toast('Chưa cấu hình Worker');
  const obj={
    name:$('#name').value.trim(), price_vnd:Number($('#price').value||0), origin_url:($('#origin').value||'').trim(), merchant:$('#merchant').value,
    sku:($('#sku').value||'').trim(), image:($('#image').value||'').trim(), category:($('#category').value||'').trim(), status:true
  };
  if(!obj.sku) return toast('Thiếu SKU');
  if(!obj.origin_url) return toast('Thiếu origin');
  try{
    const r=await fetch(base()+'/publish',{method:'POST',mode:'cors',headers:hdr(true),body:JSON.stringify(obj)});
    const text=await r.text().catch(()=>'' ); log(`[publish ${obj.sku}] ${r.status}`); $('#pubStat').textContent = r.ok? 'Publish OK' : 'Publish lỗi '+r.status; toast(r.ok?'Publish OK':'Publish lỗi '+r.status);
  }catch(e){ toast('Publish EXC: '+e.message); }
};
</script>
</body>
</html>
